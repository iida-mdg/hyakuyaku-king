<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>飲み会モチベーション共有アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color: #f6e05e;
            --whiskey-color: #F39C12;
            --hepa-color: #2ECC71; /* Green for Hepalyse */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #000;
            color: #f3f4f6;
        }
        .mochiy-pop-one-regular { font-family: 'Mochiy Pop One', sans-serif; }
        .app-page { display: none; }
        .app-page.is-active { display: flex; flex-direction: column; }
        .modal-container { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-container.is-open { display: flex; opacity: 1; }
        .element-bg { background-color: #1C1C1E; }
        .element-border { border-color: #3A3A3C; }
        .interactive-item:active { background-color: #3A3A3C; }
        .interactive-item { transition: background-color 0.1s ease-out, transform 0.1s ease-out; }
        .interactive-item:active { transform: scale(0.97); }
        .hidden { display: none !important; }

        /* Slider */
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; cursor: pointer; outline: none; border-radius: 9999px; background: #3A3A3C; height: 12px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 32px; width: 32px; background-color: var(--theme-color); border-radius: 50%; margin-top: -10px; transition: background-color 0.3s ease; }
        
        /* Bubbles */
        .carbonation-bubble { fill: #fefcbf; opacity: 0.6; }
        .popping-bubble { fill: none; stroke: #fff; stroke-width: 0.5; }

        /* Sort Buttons */
        .sort-btn { background-color: #3A3A3C; color: #a0a0a0; font-weight: bold; transition: all 0.2s ease; }
        .sort-btn.active { background-color: var(--theme-color); color: #1c1c1e; }
        
        /* Rain Effect */
        .beer-rain-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; pointer-events: none; }
        .beer-drop { position: absolute; width: 2px; height: 20px; background: linear-gradient(to bottom, rgba(210, 105, 30, 0), rgba(210, 105, 30, 1)); opacity: 0; }
        .splash { position: absolute; width: 10px; height: 5px; background: transparent; border-top: 2px solid var(--whiskey-color); border-radius: 50%; animation: splash 0.3s ease-out forwards; }
        @keyframes splash { 0% { transform: scale(0, 0); opacity: 1; } 50% { transform: scale(1.5, 0.7); opacity: 0.8; } 100% { transform: scale(2, 0); opacity: 0; } }
        
        /* Comment Bubble */
        .comment-display { background-color: rgba(28, 28, 30, 0.8); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 9999px; font-size: 0.8rem; color: #e5e7eb; text-align: center; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); white-space: nowrap; max-width: 90%; overflow: hidden; text-overflow: ellipsis; animation: pulse-comment 5s infinite ease-in-out; z-index: 20; }
        @keyframes pulse-comment { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

        /* Schedule Page Styles */
        .date-item-container { background-color: #1C1C1E; border-radius: 1rem; overflow: hidden; }
        .date-item-header:not(:last-child) { border-bottom: 1px solid #3A3A3C; }
        .date-item.is-open .date-item-header, .date-item.voted-on:not(.is-open) .date-item-header { background-color: #2C2C2E; }
        .date-item-header:active { background-color: #3A3A3C; transform: scale(0.98); }
        .details-container { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; padding: 0 1rem; }
        .date-item.is-open .details-container { max-height: 100vh; padding: 0.75rem; }
        
        .slide-up-modal-content { transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1); }
        .modal-container.is-open .slide-up-modal-content { transform: translateY(0); }
    </style>
</head>
<body class="text-gray-200">

    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-black relative">
        
        <!-- Page Containers -->
        <div id="page-container" class="h-full overflow-y-auto">
            <!-- Page 1: Today's Motivation -->
            <div id="today-page" class="app-page">
                <header class="p-4 z-30 flex justify-between items-center h-20 flex-shrink-0 border-b border-gray-800">
                    <div id="page-switcher-today" class="flex items-center gap-2 cursor-pointer">
                        <h1 class="text-lg font-bold text-gray-100">今日の飲みべ</h1>
                        <svg class="w-5 h-5 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="notification-text-container" class="relative text-right"></div>
                        <div id="auth-status-container-today"></div>
                    </div>
                </header>
                <div id="today-content-wrapper" class="flex-grow flex flex-col">
                    <div id="today-main-screen" class="flex flex-col flex-grow">
                        <div id="beer-rain-back" class="beer-rain-container z-0"></div>
                        <main class="flex-grow flex flex-col items-center p-8 pt-4 z-10">
                            <div id="beer-container" class="w-64 h-80 mx-auto my-4 flex-shrink-0 relative z-10 flex justify-center items-center">
                                <svg id="beer-svg" viewBox="0 0 150 200" class="w-full h-full" overflow="visible">
                                    <defs>
                                        <clipPath id="glass-clip"><path d="M 30 20 V 185 C 30 195, 120 195, 120 185 V 20 Z" /></clipPath>
                                        <linearGradient id="glass-shine" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:white; stop-opacity:0" /><stop offset="50%" style="stop-color:white; stop-opacity:0.3" /><stop offset="100%" style="stop-color:white; stop-opacity:0" /></linearGradient>
                                    </defs>
                                    <path d="M 25 10 C 25 20, 125 20, 125 10 L 122 185 C 122 195, 28 195, 28 185 Z" fill="#e2e8f0" opacity="0.1"/>
                                    <g clip-path="url(#glass-clip)"><path id="beer-liquid" d="" fill="#fbbF24" /><g id="carbonation-bubbles"></g></g>
                                    <path id="beer-foam" d="" fill="#ffffff"/><g id="popping-bubbles"></g>
                                    <path d="M 20 5 C 20 20, 130 20, 130 5 L 125 190 C 125 200, 25 200, 25 190 Z" fill="transparent" stroke="#e2e8f0" stroke-width="0.5" opacity="0.3" />
                                    <path d="M 125 50 C 150 60, 150 130, 125 140 L 122 135 C 140 125, 140 65, 122 55 Z" fill="#e2e8f0" opacity="0.2"/>
                                    <path d="M 40 30 C 45 80, 45 150, 40 180" fill="none" stroke="url(#glass-shine)" stroke-width="5" stroke-linecap="round" />
                                </svg>
                                <img id="whiskey-image" src="https://iida-mdg.github.io/nomibe-app/whiskey.png" class="hidden h-full object-contain" alt="ウイスキーボトル">
                                <img id="hepa-image" src="https://iida-mdg.github.io/nomibe-app/hepa.png" class="hidden h-full object-contain" alt="ヘパリーゼ">
                            </div>
                            <div class="w-full max-w-xs flex-shrink-0">
                                <input type="range" id="motivation-slider" min="0" max="100" value="50" class="w-full">
                                <div id="percentage-display" class="text-center h-20 mt-4"></div>
                            </div>
                        </main>
                        <div id="beer-rain-front" class="beer-rain-container z-20"></div>
                        <footer class="p-4 w-full mt-auto z-20">
                            <button id="publish-motivation-btn" class="w-full text-white font-bold py-3 rounded-2xl interactive-item">みんなの飲みベを見る</button>
                        </footer>
                    </div>
                    <div id="today-results-screen" class="hidden flex-col">
                         <div class="p-4 flex items-center justify-between">
                            <button id="back-to-main-btn" class="text-amber-500 text-sm font-bold interactive-item px-2 py-1 rounded-lg">&lt; 戻る</button>
                            <h1 class="text-lg font-bold text-gray-100">みんなの飲みベ</h1>
                            <div id="sort-controls" class="flex items-center text-xs gap-1">
                                <button id="sort-by-motivation-btn" class="sort-btn px-2 py-1 rounded-md">飲みべ順</button>
                                <button id="sort-by-date-btn" class="sort-btn px-2 py-1 rounded-md">新着順</button>
                            </div>
                        </div>
                        <main id="participants-list" class="flex-grow w-full p-4 pt-0 space-y-3"></main>
                    </div>
                </div>
            </div>
            <!-- Page 2: Schedule -->
            <div id="schedule-page" class="app-page">
                 <header class="p-4 z-30 flex justify-between items-center h-20 flex-shrink-0 border-b border-gray-800">
                    <div id="page-switcher-schedule" class="flex items-center gap-2 cursor-pointer">
                        <h1 class="text-lg font-bold text-gray-100">飲みべスケジュール</h1>
                        <svg class="w-5 h-5 text-gray-400 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                    </div>
                    <div id="auth-status-container-schedule"></div>
                </header>
                 <main class="p-4 space-y-4">
                    <div id="date-list-container"></div>
                 </main>
            </div>
        </div>

        <!-- Modals -->
        <div id="profile-setup-modal" class="modal-container fixed inset-0 bg-black/60 items-center justify-center z-50 p-4">
             <div class="element-bg rounded-2xl w-full max-w-sm p-6 text-center">
                 <h2 class="text-xl font-bold mb-4">プロフィール設定</h2>
                 <p class="text-gray-400 mb-6">あなたの名前を設定してください。</p>
                 <div id="avatar-preview" class="mb-6 w-24 h-24 mx-auto"></div>
                 <input type="text" id="name-input" placeholder="名前を入力" class="w-full bg-black border element-border rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4">
                 <button id="save-profile-button" class="w-full bg-amber-600 text-white font-bold py-3 rounded-lg hover:bg-amber-700 interactive-item disabled:bg-gray-600 disabled:cursor-not-allowed">保存する</button>
             </div>
        </div>
        <div id="comment-modal" class="modal-container fixed inset-0 bg-black/60 items-center justify-center z-50 p-4">
             <div class="element-bg rounded-2xl w-full max-w-sm p-6 text-center">
                 <h2 class="text-xl font-bold mb-4">コメント</h2>
                 <textarea id="comment-input" placeholder="ひとことどうぞ！" class="w-full bg-black border element-border rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4 h-24 resize-none"></textarea>
                 <div class="flex gap-2">
                    <button id="cancel-comment-button" class="w-full bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 interactive-item">キャンセル</button>
                    <button id="save-comment-button" class="w-full bg-amber-600 text-white font-bold py-3 rounded-lg hover:bg-amber-700 interactive-item">保存</button>
                 </div>
             </div>
        </div>
        <div id="level-selector-modal" class="modal-container fixed inset-0 bg-black/60 items-end justify-center z-50 p-4">
             <div class="w-full max-w-md mx-auto">
                 <div id="level-selector-content" class="slide-up-modal-content bg-[#1C1C1E]/80 backdrop-blur-xl rounded-2xl w-full p-2 space-y-2">
                     <div id="level-selector-options" class="flex justify-around items-center p-4"></div>
                 </div>
                 <button id="close-level-selector" class="slide-up-modal-content w-full bg-[#E5E5EA] text-black font-bold py-4 rounded-2xl mt-2 hover:bg-gray-300 transition-colors">キャンセル</button>
             </div>
        </div>
        <div id="loading-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 transition-opacity duration-300">
             <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-amber-500"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, serverTimestamp, collection, query, where, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State Management ---
        const AppState = { LOADING: 'loading', NEEDS_PROFILE: 'needs_profile', READY: 'ready', ERROR: 'error' };
        let currentAppState = AppState.LOADING;
        let currentPage = 'today'; // 'today' or 'schedule'
        let currentTodayScreen = 'main'; // 'main' or 'results'

        // --- Firebase & Global Variables ---
        const firebaseConfig = {
            apiKey: "AIzaSyAP7CCx3ZoaQMkRDVxwHx7UEdLfm2D5P3w",
            authDomain: "nomibe-app-51fd8.firebaseapp.com",
            projectId: "nomibe-app-51fd8",
            storageBucket: "nomibe-app-51fd8.appspot.com",
            messagingSenderId: "109791522849",
            appId: "1:109791522849:web:f195e9377d6dc485ae7360"
        };
        const appId = 'default-nomibe-app-v2';
        
        const AVATAR_COLORS = [
            ['#f97316','#f59e0b'], ['#84cc16','#a3e635'], ['#22d3ee','#67e8f9'], ['#8b5cf6','#a78bfa'],
            ['#ec4899','#f472b6'], ['#ef4444','#f87171'], ['#10b981','#34d399'], ['#6366f1','#818cf8']
        ];

        let db, auth, userId = null, userProfile = null;
        let unsubscribeListeners = [];
        let unsubscribeResults = null, unsubscribeMainScreen = null;
        let allPosts = [];
        let currentSortOrder = 'motivation';
        let tempColorIndex = 0;
        const userProfileCache = new Map();
        
        let hyperModeActive = false;
        let hepaModeActive = false;
        let hyperModeTimer = null;
        let currentMotivation = 50;

        const elements = {
            // Pages
            todayPage: document.getElementById('today-page'),
            schedulePage: document.getElementById('schedule-page'),
            // Header
            pageSwitcherToday: document.getElementById('page-switcher-today'),
            pageSwitcherSchedule: document.getElementById('page-switcher-schedule'),
            authStatusContainerToday: document.getElementById('auth-status-container-today'),
            authStatusContainerSchedule: document.getElementById('auth-status-container-schedule'),
            notificationTextContainer: document.getElementById('notification-text-container'),
            // Today Page
            todayMainScreen: document.getElementById('today-main-screen'),
            todayResultsScreen: document.getElementById('today-results-screen'),
            slider: document.getElementById('motivation-slider'),
            percentageDisplay: document.getElementById('percentage-display'),
            beerSvg: document.getElementById('beer-svg'),
            whiskeyImage: document.getElementById('whiskey-image'),
            hepaImage: document.getElementById('hepa-image'),
            beer: { liquid: document.getElementById('beer-liquid'), foam: document.getElementById('beer-foam'), carbonationBubbles: document.getElementById('carbonation-bubbles'), poppingBubbles: document.getElementById('popping-bubbles') },
            publishBtn: document.getElementById('publish-motivation-btn'),
            beerRainBack: document.getElementById('beer-rain-back'),
            beerRainFront: document.getElementById('beer-rain-front'),
            backBtn: document.getElementById('back-to-main-btn'),
            participantsList: document.getElementById('participants-list'),
            sortControls: { byMotivation: document.getElementById('sort-by-motivation-btn'), byDate: document.getElementById('sort-by-date-btn') },
            // Schedule Page
            dateListContainer: document.getElementById('date-list-container'),
            // Modals
            loadingOverlay: document.getElementById('loading-overlay'),
            profileModal: { container: document.getElementById('profile-setup-modal'), avatar: document.getElementById('avatar-preview'), nameInput: document.getElementById('name-input'), saveBtn: document.getElementById('save-profile-button') },
            commentModal: { container: document.getElementById('comment-modal'), input: document.getElementById('comment-input'), saveBtn: document.getElementById('save-comment-button'), cancelBtn: document.getElementById('cancel-comment-button') },
            levelSelectorModal: { container: document.getElementById('level-selector-modal'), content: document.getElementById('level-selector-content'), options: document.getElementById('level-selector-options'), closeBtn: document.getElementById('close-level-selector') }
        };

        // --- Master UI Control Function ---
        function renderUI() {
            elements.loadingOverlay.classList.toggle('hidden', currentAppState !== AppState.LOADING);
            elements.profileModal.container.classList.toggle('is-open', currentAppState === AppState.NEEDS_PROFILE);
            
            if (currentAppState === AppState.READY) {
                elements.todayPage.classList.toggle('is-active', currentPage === 'today');
                elements.schedulePage.classList.toggle('is-active', currentPage === 'schedule');
                elements.notificationTextContainer.classList.toggle('hidden', currentPage !== 'today');

                if (currentPage === 'today') {
                    elements.todayMainScreen.classList.toggle('hidden', currentTodayScreen !== 'main');
                    elements.todayResultsScreen.classList.toggle('hidden', currentTodayScreen !== 'results');
                }
            } else {
                elements.todayPage.classList.remove('is-active');
                elements.schedulePage.classList.remove('is-active');
            }
        }

        // --- App Initialization ---
        async function main() {
            renderUI();
            try {
                if (!firebaseConfig.apiKey) throw new Error("Firebase config is missing.");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupEventListeners();
                initPercentageDisplay();
                updateSortButtons();
                setupAuthListener();
                startAnimations();
            } catch (error) {
                console.error("Initialization Error:", error);
                currentAppState = AppState.ERROR;
            }
        }

        // --- Authentication Flow ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        if (typeof userProfile.colorIndex === 'undefined') {
                            userProfile.colorIndex = Math.floor(Math.random() * AVATAR_COLORS.length);
                            setDoc(userDocRef, { colorIndex: userProfile.colorIndex }, { merge: true });
                        }
                        updateAppTheme(userProfile.colorIndex);
                        const authStatusHTML = `
                            <div class="flex items-center gap-2 cursor-pointer interactive-item p-1 rounded-full bg-black/30 backdrop-blur-sm">
                                ${generateAvatar(userProfile.name, userProfile.colorIndex, 'w-10 h-10 text-xl')}
                            </div>
                        `;
                        elements.authStatusContainerToday.innerHTML = authStatusHTML;
                        elements.authStatusContainerSchedule.innerHTML = authStatusHTML;
                        currentAppState = AppState.READY;
                        initializeAppUI();
                    } else {
                        currentAppState = AppState.NEEDS_PROFILE;
                        tempColorIndex = Math.floor(Math.random() * AVATAR_COLORS.length);
                        elements.profileModal.avatar.innerHTML = generateAvatar('？', tempColorIndex);
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Sign-in failed:", e);
                        currentAppState = AppState.ERROR;
                    }
                }
                renderUI();
            });
        }
        
        function initializeAppUI() {
            generateDateList();
            switchPage(currentPage, false); // Initialize the default page
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            [elements.pageSwitcherToday, elements.pageSwitcherSchedule].forEach(el => {
                el.addEventListener('click', () => {
                    switchPage(currentPage === 'today' ? 'schedule' : 'today');
                });
            });
            
            elements.publishBtn.addEventListener('click', () => {
                currentTodayScreen = 'results';
                publishAndShowResults();
            });
            
            elements.backBtn.addEventListener('click', () => {
                if(unsubscribeResults) unsubscribeResults();
                unsubscribeResults = null;
                stopResultsAnimation();
                if (observer) observer.disconnect();
                observer = null;
                currentTodayScreen = 'main';
                setupMainScreenListeners();
                renderUI();
            });
            
            elements.slider.addEventListener('input', handleSliderInput);
            elements.slider.addEventListener('mousedown', handleSliderHold);
            elements.slider.addEventListener('touchstart', handleSliderHold);
            elements.slider.addEventListener('mouseup', handleSliderRelease);
            elements.slider.addEventListener('touchend', handleSliderRelease);

            const pm = elements.profileModal;
            pm.nameInput.addEventListener('input', () => {
                const name = pm.nameInput.value.trim();
                pm.saveBtn.disabled = !name;
                const colorIndex = userProfile ? userProfile.colorIndex : tempColorIndex;
                pm.avatar.innerHTML = generateAvatar(name || '？', colorIndex);
            });
            pm.saveBtn.addEventListener('click', saveProfile);

            elements.sortControls.byMotivation.addEventListener('click', () => {
                currentSortOrder = 'motivation';
                updateSortButtons();
                sortAndRenderPosts();
            });
            elements.sortControls.byDate.addEventListener('click', () => {
                currentSortOrder = 'date';
                updateSortButtons();
                sortAndRenderPosts();
            });

            [elements.authStatusContainerToday, elements.authStatusContainerSchedule].forEach(el => {
                el.addEventListener('click', () => {
                    if (currentAppState !== AppState.READY || !userProfile) return;
                    const pm = elements.profileModal;
                    pm.nameInput.value = userProfile.name || '';
                    pm.avatar.innerHTML = generateAvatar(userProfile.name || '？', userProfile.colorIndex);
                    pm.saveBtn.disabled = !userProfile.name;
                    pm.container.classList.add('is-open');
                });
            });
            
            elements.participantsList.addEventListener('click', (e) => {
                const card = e.target.closest('.participant-card');
                if (card && card.dataset.userId === userId) {
                    const post = allPosts.find(p => p.id === userId);
                    elements.commentModal.input.value = post?.comment || '';
                    elements.commentModal.saveBtn.dataset.context = 'today';
                    elements.commentModal.container.classList.add('is-open');
                }
            });
            elements.commentModal.cancelBtn.addEventListener('click', () => {
                elements.commentModal.container.classList.remove('is-open');
            });
            elements.commentModal.saveBtn.addEventListener('click', async (e) => {
                const context = e.currentTarget.dataset.context;
                const comment = elements.commentModal.input.value.trim();
                
                if (context === 'today') {
                    const docRef = doc(db, `artifacts/${appId}/public/data/motivation_posts`, userId);
                    try {
                        await updateDoc(docRef, { comment: comment });
                    } catch (error) { 
                         if (error.code === 'not-found' || error.message.includes("No document to update")) {
                            await setDoc(docRef, { comment: comment }, { merge: true });
                         } else {
                            console.error("Failed to save today's comment:", error); 
                         }
                    }
                } else if (context) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/drinking_motivation`, context);
                    const fieldPath = `records.${userId}.comment`;
                    try {
                        await updateDoc(docRef, { [fieldPath]: comment });
                    } catch (error) { 
                        if (error.code === 'not-found' || error.message.includes("No document to update")) {
                           await setDoc(docRef, { records: { [userId]: { comment: comment } } }, { merge: true });
                        } else {
                           console.error("Failed to save schedule comment:", error); 
                        }
                    }
                }

                elements.commentModal.container.classList.remove('is-open');
                if (e.currentTarget) {
                    delete e.currentTarget.dataset.context;
                }
            });
            
            // Schedule Page Listeners
            elements.dateListContainer.addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                const participantItem = e.target.closest('.participant-item');

                if (actionTarget) {
                    const dateItem = actionTarget.closest('.date-item');
                    if (!dateItem) return;
                    const action = actionTarget.dataset.action;
                    if (action === 'open-selector') {
                        e.stopPropagation();
                        openLevelSelector(dateItem.dataset.date);
                    } else if (action === 'toggle-details') {
                        toggleParticipantList(dateItem);
                    }
                } else if (participantItem && participantItem.dataset.userId === userId) {
                    openScheduleCommentModal(participantItem.dataset.date);
                }
            });
            elements.levelSelectorModal.closeBtn.addEventListener('click', () => elements.levelSelectorModal.container.classList.remove('is-open'));
        }

        // --- Page Switching ---
        function switchPage(page, animate = true) {
            currentPage = page;
            
            // Detach all listeners first
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            if (unsubscribeMainScreen) {
                unsubscribeMainScreen();
                unsubscribeMainScreen = null;
            }
            if (unsubscribeResults) {
                unsubscribeResults();
                unsubscribeResults = null;
            }

            if (page === 'today') {
                setupMainScreenListeners();
                loadUserMotivation();
            } else if (page === 'schedule') {
                listenToAllMotivationData();
            }
            renderUI();
        }

        // --- Core Logic ---
        async function loadUserMotivation() {
            const postDocRef = doc(db, `artifacts/${appId}/public/data/motivation_posts`, userId);
            const postDoc = await getDoc(postDocRef);
            if (postDoc.exists()) {
                const motivation = postDoc.data().motivation;
                if (typeof motivation === 'number') {
                    if (motivation === 120) {
                        activateHyperMode(false);
                    } else if (motivation === -20) {
                        activateHepaMode(false);
                    }
                    else {
                        elements.slider.value = motivation;
                        handleSliderInput();
                    }
                }
            }
        }

        let observer = null;
        function setupIntersectionObserver() {
            if (observer) observer.disconnect();
            const options = { root: elements.participantsList, rootMargin: '100px 0px 100px 0px', threshold: 0.01 };
            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const anim = resultsAnimations.find(a => a.cardId === entry.target.id);
                    if (anim) anim.isActive = entry.isIntersecting;
                });
            }, options);
        }

        async function publishAndShowResults() {
            if (currentAppState !== AppState.READY) return;
            if (unsubscribeMainScreen) unsubscribeMainScreen();
            unsubscribeMainScreen = null;

            currentTodayScreen = 'results';
            renderUI();
            
            const postDocRef = doc(db, `artifacts/${appId}/public/data/motivation_posts`, userId);
            try {
                await setDoc(postDocRef, {
                    motivation: currentMotivation,
                    name: userProfile.name,
                    avatarSeed: userProfile.name,
                    colorIndex: userProfile.colorIndex,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                setupIntersectionObserver();
                setupResultsListener();
            } catch (error) {
                console.error("Failed to publish motivation:", error);
                currentTodayScreen = 'main';
                renderUI();
            } 
        }

        function setupResultsListener() {
            if (unsubscribeResults) unsubscribeResults();
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/motivation_posts`);
            const twentyHoursAgo = new Date(Date.now() - 20 * 60 * 60 * 1000);
            const q = query(postsCollectionRef, where("updatedAt", ">=", twentyHoursAgo));
            unsubscribeResults = onSnapshot(q, (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderPosts();
            }, (error) => console.error("Snapshot error:", error));
        }

        function setupMainScreenListeners() {
            if (unsubscribeMainScreen) unsubscribeMainScreen();
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/motivation_posts`);
            const twentyHoursAgo = new Date(Date.now() - 20 * 60 * 60 * 1000);
            const q = query(postsCollectionRef, where("updatedAt", ">=", twentyHoursAgo));
            unsubscribeMainScreen = onSnapshot(q, (snapshot) => {
                const posts = snapshot.docs.map(doc => doc.data());
                const hundredCount = posts.filter(p => p.motivation === 100).length;
                const hyperCount = posts.filter(p => p.motivation === 120).length;
                updateNotificationText(hundredCount, hyperCount);
            }, (error) => console.error("Error listening to main screen data:", error));
        }
        
        function updateNotificationText(hundredCount, hyperCount) {
            const container = elements.notificationTextContainer;
            let html = '';
            if (hyperCount > 0) {
                html += `<div class="font-bold text-sm text-red-500">120%が${hyperCount}人います</div>`;
            }
            if (hundredCount > 0) {
                html += `<div class="text-white font-bold text-sm">100%が${hundredCount}人います</div>`;
            }
            container.innerHTML = html;
        }

        function updateSortButtons() {
            elements.sortControls.byMotivation.classList.toggle('active', currentSortOrder === 'motivation');
            elements.sortControls.byDate.classList.toggle('active', currentSortOrder === 'date');
        }

        function sortAndRenderPosts() {
            if (!allPosts) return;
            const postsToSort = [...allPosts];
            if (currentSortOrder === 'motivation') {
                postsToSort.sort((a, b) => (b.motivation || 0) - (a.motivation || 0));
            } else {
                postsToSort.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
            }
            renderPosts(postsToSort);
        }

        let resultsAnimations = [];
        let resultsAnimationRequest;

        function renderPosts(sortedPosts) {
            stopResultsAnimation();
            const currentlyVisible = new Set(resultsAnimations.filter(a => a.isActive).map(a => a.cardId));
            elements.participantsList.innerHTML = '';
            resultsAnimations = [];
            if (sortedPosts.length === 0) {
                elements.participantsList.innerHTML = '<p class="text-gray-500 text-center p-4">まだ誰も投稿していません👀<br>（過去20時間）</p>';
                return;
            }
            sortedPosts.forEach(post => {
                const isMe = post.id === userId;
                const motivation = post.motivation || 0;
                const div = document.createElement('div');
                div.className = `participant-card element-bg rounded-2xl p-4 relative overflow-hidden flex items-center justify-between ${isMe ? 'ring-2 ring-amber-500' : ''}`;
                div.dataset.userId = post.id;

                const liquidBgId = `liquid-bg-${post.id}`;
                const cardId = `card-${post.id}`;
                div.id = cardId;
                const colorIndex = typeof post.colorIndex !== 'undefined' 
                    ? post.colorIndex 
                    : Math.abs((post.avatarSeed||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % AVATAR_COLORS.length;

                let commentHTML = '';
                if (post.comment) {
                    commentHTML = `<div class="comment-display">${post.comment}</div>`;
                }

                div.innerHTML = `
                    ${commentHTML}
                    <div class="absolute top-0 left-0 w-full h-full z-0">
                        <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <defs>
                                <clipPath id="clip-${liquidBgId}">
                                    <path id="clip-path-${liquidBgId}"></path>
                                </clipPath>
                            </defs>
                            <g class="liquid-container">
                                <path id="${liquidBgId}" />
                                <g class="bubbles-bg-container" clip-path="url(#clip-${liquidBgId})"></g>
                            </g>
                        </svg>
                    </div>
                    <div class="relative z-10 flex items-center justify-between w-full">
                        <div class="flex items-center gap-3 flex-grow min-w-0">
                            <div class="text-center w-16 flex-shrink-0">${generateAvatar(post.avatarSeed || post.name, colorIndex, 'w-16 h-16 text-2xl')}</div>
                            <div class="flex flex-col items-start min-w-0">
                                <p class="text-xl font-bold text-white truncate w-full" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">${post.name}</p>
                                <p class="text-sm text-gray-300 mt-1" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.7);">${formatTimeAgo(post.updatedAt)}</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0 flex items-baseline justify-end pl-2" style="width: 120px; text-shadow: 2px 2px 8px rgba(0,0,0,0.5);">
                            <span class="text-6xl font-bold text-white mochiy-pop-one-regular">${motivation}</span>
                            <span class="text-2xl text-gray-300 font-semibold ml-1">%</span>
                        </div>
                    </div>`;
                
                const liquidPathEl = div.querySelector(`#${liquidBgId}`);
                if (motivation === 120) {
                    liquidPathEl.setAttribute('fill', 'var(--whiskey-color)');
                } else if (motivation === -20) {
                    liquidPathEl.setAttribute('fill', 'var(--hepa-color)');
                }
                else {
                    liquidPathEl.setAttribute('fill', '#fbbF24');
                }

                elements.participantsList.appendChild(div);
                const bubblesContainer = div.querySelector('.bubbles-bg-container');
                const liquidPath = div.querySelector(`#${liquidBgId}`);
                const bubbles = [];
                const numBubbles = motivation === 120 || motivation === -20 ? 0 : Math.floor(5 + 60 * (motivation / 100));
                for(let i = 0; i < numBubbles; i++) {
                    const ellipse = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                    ellipse.setAttribute('fill', 'white');
                    ellipse.setAttribute('opacity', '0.7');
                    bubblesContainer.appendChild(ellipse);
                    const speedMultiplier = 1 + motivation / 100 * 2;
                    bubbles.push({ el: ellipse, x: Math.random() * 100, y: Math.random() * 100 + 105, r: Math.random() * 0.67 + 0.22, speed: (0.05 + Math.random() * 0.1) * speedMultiplier });
                }
                resultsAnimations.push({ id: post.id, cardId: cardId, path: liquidPath, bubbles: bubbles, motivation: motivation, isActive: currentlyVisible.has(cardId) });
                if (observer) observer.observe(div);
            });
            startResultsAnimation();
        }

        function startResultsAnimation() {
            let startTime = null;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                resultsAnimations.forEach(anim => {
                    if (!anim.isActive) return;
                    const cardElement = document.getElementById(anim.cardId);
                    if (!cardElement) return;
                    const motivation = anim.motivation;
                    const topY = motivation >= 100 ? 0 : 100 - motivation;
                    const swayX = Math.sin(elapsed / 2500 + anim.id.charCodeAt(0)) * 8; 
                    const swayY = Math.cos(elapsed / 2000 + anim.id.charCodeAt(1)) * 5;
                    const controlPointX = 50 + Math.sin(elapsed / 2200 + anim.id.charCodeAt(2)) * 10;
                    const liquidPathD = `M -10 ${topY + swayY} Q ${controlPointX} ${topY + swayY + swayX}, 110 ${topY + swayY} V 110 H -10 Z`;
                    
                    if (motivation > 0) {
                        anim.path.setAttribute('d', liquidPathD);
                        const clipPath = document.getElementById(`clip-path-${anim.path.id}`);
                        if (clipPath) clipPath.setAttribute('d', liquidPathD);
                    } else {
                        anim.path.setAttribute('d', '');
                        const clipPath = document.getElementById(`clip-path-${anim.path.id}`);
                        if (clipPath) clipPath.setAttribute('d', '');
                    }

                    const aspect = cardElement.clientWidth / cardElement.clientHeight;
                    if (!aspect || !isFinite(aspect)) return;
                    anim.bubbles.forEach(b => {
                        b.y -= b.speed;
                        if (b.y < topY - b.r) { b.y = 105; b.x = Math.random() * 100; }
                        const rx = b.r; const ry = b.r * aspect;
                        b.el.setAttribute('cx', `${b.x}`);
                        b.el.setAttribute('cy', `${b.y}`);
                        b.el.setAttribute('rx', rx);
                        b.el.setAttribute('ry', ry);
                    });
                });
                resultsAnimationRequest = requestAnimationFrame(animate);
            }
            resultsAnimationRequest = requestAnimationFrame(animate);
        }

        function stopResultsAnimation() {
            if (resultsAnimationRequest) cancelAnimationFrame(resultsAnimationRequest);
            resultsAnimationRequest = null;
        }

        async function saveProfile() {
            const name = elements.profileModal.nameInput.value.trim();
            if (!name || !userId || elements.profileModal.saveBtn.disabled) return;
            elements.profileModal.saveBtn.disabled = true;
            const wasInitialSetup = currentAppState === AppState.NEEDS_PROFILE;
            const profileData = { name };
            if (wasInitialSetup) {
                profileData.createdAt = serverTimestamp();
                profileData.colorIndex = tempColorIndex;
            }
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
            try {
                await setDoc(userDocRef, profileData, { merge: true });
                const updatedDoc = await getDoc(userDocRef);
                userProfile = updatedDoc.data();
                updateAppTheme(userProfile.colorIndex);
                const authStatusHTML = `
                    <div class="flex items-center gap-2 cursor-pointer interactive-item p-1 rounded-full bg-black/30 backdrop-blur-sm">
                        ${generateAvatar(userProfile.name, userProfile.colorIndex, 'w-10 h-10 text-xl')}
                    </div>
                `;
                elements.authStatusContainerToday.innerHTML = authStatusHTML;
                elements.authStatusContainerSchedule.innerHTML = authStatusHTML;

                if (wasInitialSetup) {
                    currentAppState = AppState.READY;
                    initializeAppUI();
                } else {
                    elements.profileModal.container.classList.remove('is-open');
                }
            } catch (error) {
                console.error("Profile save error:", error);
            } finally {
                 elements.profileModal.saveBtn.disabled = false;
            }
        }
        
        // --- Visualization & Helpers ---
        function updateAppTheme(colorIndex, isHyper = false, isHepa = false) {
            const whiskeyColor = 'var(--whiskey-color)';
            const hepaColor = 'var(--hepa-color)';
            const userColor = AVATAR_COLORS[colorIndex] ? AVATAR_COLORS[colorIndex][0] : '#f97316';
            
            let color = userColor;
            if (isHyper) color = whiskeyColor;
            if (isHepa) color = hepaColor;
            
            document.documentElement.style.setProperty('--theme-color', color);
            elements.publishBtn.style.backgroundColor = color;
        }

        let beerState = { liquidTop: 190, foamTop: 190, motivation: 50 };
        let foamAnimationId = null; 

        function updateBeerVisualization(motivation) {
            currentMotivation = motivation;
            beerState.motivation = motivation;
            const liquid = elements.beer.liquid;
            const foam = elements.beer.foam;
            
            elements.beerSvg.classList.toggle('hidden', hyperModeActive || hepaModeActive);
            elements.whiskeyImage.classList.toggle('hidden', !hyperModeActive);
            elements.hepaImage.classList.toggle('hidden', !hepaModeActive);

            if (!hyperModeActive && !hepaModeActive) {
                const GLASS_BOTTOM_Y = 185;
                const MAX_LIQUID_HEIGHT = 165;
                const liquidHeight = (motivation / 100) * MAX_LIQUID_HEIGHT;
                const liquidTop = GLASS_BOTTOM_Y - liquidHeight;
                if (motivation > 0) {
                    liquid.setAttribute('d', `M 30 ${liquidTop} V 185 C 30 195, 120 195, 120 185 V ${liquidTop} Z`);
                } else {
                    liquid.setAttribute('d', '');
                }
                beerState.liquidTop = liquidTop;

                if (foamAnimationId) { cancelAnimationFrame(foamAnimationId); foamAnimationId = null; }
                if (liquidHeight > 0) {
                    if (motivation === 100) startFoamAnimation(liquidTop);
                    else {
                        const foamHeight = Math.max(8, liquidHeight * 0.15);
                        foam.setAttribute('d', `M 30,${liquidTop} C 40,${liquidTop-foamHeight}, 60,${liquidTop-foamHeight}, 75,${liquidTop} S 100,${liquidTop+5}, 120,${liquidTop} Z`);
                    }
                } else {
                    foam.setAttribute('d', '');
                }
            }
            updatePercentageDisplay(motivation);
        }

        function startFoamAnimation(liquidTop) {
            let startTime = null;
            const foamPath = elements.beer.foam;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const y1 = Math.sin(elapsed / 800) * 2 - 15;
                const y2 = Math.cos(elapsed / 700) * 3 - 30;
                const y3 = Math.sin(elapsed / 900) * 2.5 - 35;
                const y4 = Math.cos(elapsed / 600) * 2 - 30;
                const y5 = Math.sin(elapsed / 1000) * 2 - 30;
                const y6 = Math.cos(elapsed / 750) * 2.5;
                foamPath.setAttribute('d', `M 30 ${liquidTop} C 30 ${liquidTop}, 25 ${liquidTop + y1}, 25 ${liquidTop + y1} L 20 ${liquidTop-20} C 15 ${liquidTop + y2}, 25 ${liquidTop + y3}, 40 ${liquidTop + y4} L 110 ${liquidTop + y5} C 125 ${liquidTop + y5}, 135 ${liquidTop + y6}, 120 ${liquidTop} Z`);
                foamAnimationId = requestAnimationFrame(animate);
            }
            foamAnimationId = requestAnimationFrame(animate);
        }
        
        const carbonationBubbles = [];
        const poppingBubbles = [];
        function startAnimations() {
            for (let i = 0; i < 80; i++) { // Increased bubble count for hyper mode
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                elements.beer.carbonationBubbles.appendChild(circle);
                carbonationBubbles.push({ el: circle, x: 35 + Math.random() * 80, y: 190, r: Math.random() * 1.2 + 0.3, baseSpeed: Math.random() * 0.5 + 0.2 });
            }
            for (let i = 0; i < 15; i++) {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                elements.beer.poppingBubbles.appendChild(circle);
                poppingBubbles.push({ el: circle, x: 0, y: 0, r: 0, lifetime: 999, maxLifetime: 100 });
            }
            function animateBeer() {
                const motivationRatio = Math.min(beerState.motivation, 100) / 100;
                const speedMultiplier = hyperModeActive ? 10 : 0.5 + motivationRatio * 2.5;
                const activeBubbleCount = hyperModeActive ? 80 : Math.floor(40 * motivationRatio);

                for (let i = 0; i < carbonationBubbles.length; i++) {
                    const b = carbonationBubbles[i];
                    if (i < activeBubbleCount && beerState.motivation > 0) {
                        b.y -= b.baseSpeed * speedMultiplier;
                        if (b.y < (hyperModeActive ? -500 : beerState.liquidTop)) {
                            b.y = 190;
                            b.x = 35 + Math.random() * 80;
                        }
                        b.el.setAttribute('r', b.r);
                    } else {
                        b.el.setAttribute('r', 0);
                    }
                    b.el.setAttribute('cx', b.x);
                    b.el.setAttribute('cy', b.y);
                    b.el.classList.add('carbonation-bubble');
                }

                poppingBubbles.forEach(b => {
                    if (beerState.motivation > 0 && !hyperModeActive) {
                        b.lifetime++;
                        if (b.lifetime > b.maxLifetime) {
                            b.lifetime = 0; b.maxLifetime = 50 + Math.random() * 100;
                            const foamTopY = beerState.liquidTop - (beerState.motivation === 100 ? 30 : 0);
                            b.x = 35 + Math.random() * 80; b.y = foamTopY - 5 - Math.random() * 10;
                            b.r = Math.random() * 3 + 1;
                        }
                        b.el.setAttribute('r', b.r * (b.lifetime / b.maxLifetime));
                    } else {
                        b.el.setAttribute('r', 0);
                    }
                    b.el.setAttribute('cx', b.x);
                    b.el.setAttribute('cy', b.y);
                    b.el.classList.add('popping-bubble');
                });
                requestAnimationFrame(animateBeer);
            }
            animateBeer();
            updateBeerVisualization(parseInt(elements.slider.value));
        }
        
        let percentageTextEl, percentageClipText, percentageBubblesContainer, percentageRect;
        function initPercentageDisplay() {
            elements.percentageDisplay.innerHTML = `<svg viewBox="0 0 220 80" class="w-full h-full" overflow="visible"><defs><clipPath id="percentage-clip"><text id="percentage-clip-text" x="110" y="60" text-anchor="middle" class="mochiy-pop-one-regular" font-size="70" fill="white">50%</text></clipPath></defs><text id="percentage-text" x="110" y="60" text-anchor="middle" class="mochiy-pop-one-regular" font-size="70" fill="#4a5568">50%</text><g clip-path="url(#percentage-clip)"><rect id="percentage-rect" x="0" y="0" width="220" height="80" fill="#fbbF24" /><g id="percentage-bubbles-container"></g></g></svg>`;
            percentageTextEl = document.getElementById('percentage-text');
            percentageClipText = document.getElementById('percentage-clip-text');
            percentageBubblesContainer = document.getElementById('percentage-bubbles-container');
            percentageRect = document.getElementById('percentage-rect');
            const percentageBubbles = [];
            for (let i = 0; i < 40; i++) {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                percentageBubblesContainer.appendChild(circle);
                percentageBubbles.push({ el: circle, x: Math.random() * 220, y: Math.random() * 80, r: Math.random() * 2 + 1, speed: Math.random() * 0.3 + 0.1 });
            }
            function animatePercentage() {
                percentageBubbles.forEach(b => {
                    b.y -= b.speed;
                    if (b.y < -b.r) { b.y = 80 + b.r; b.x = Math.random() * 220; }
                    b.el.setAttribute('cx', b.x);
                    b.el.setAttribute('cy', b.y);
                    b.el.setAttribute('r', b.r);
                    b.el.setAttribute('fill', 'white');
                    b.el.setAttribute('opacity', '0.7');
                });
                requestAnimationFrame(animatePercentage);
            }
            animatePercentage();
        }

        function updatePercentageDisplay(motivation) {
            const text = `${motivation}%`;
            if(percentageTextEl) {
                percentageTextEl.textContent = text;
                percentageClipText.textContent = text;
                if (motivation === 120) {
                    percentageRect.setAttribute('fill', 'var(--whiskey-color)');
                } else if (motivation === -20) {
                    percentageRect.setAttribute('fill', 'var(--hepa-color)');
                } else {
                    percentageRect.setAttribute('fill', '#fbbF24');
                }
            }
        }
        
        // --- Hidden Command Logic ---
        function handleSliderInput() {
            if (hyperModeActive) deactivateHyperMode();
            if (hepaModeActive) deactivateHepaMode();
            updateBeerVisualization(parseInt(elements.slider.value));
        }
        function handleSliderHold(e) {
            if (e.target.value == 100) {
                hyperModeTimer = setTimeout(() => { if (e.target.value == 100) activateHyperMode(true); }, 2000);
            } else if (e.target.value == 0) {
                hyperModeTimer = setTimeout(() => { if (e.target.value == 0) activateHepaMode(true); }, 3000);
            }
        }
        function handleSliderRelease() {
            clearTimeout(hyperModeTimer);
        }
        function activateHyperMode(withAnimation) {
            if (hyperModeActive) return;
            hyperModeActive = true;
            updateBeerVisualization(120);
            updateAppTheme(userProfile.colorIndex, true, false);
            if (withAnimation) startBeerRain();
        }
        function deactivateHyperMode() {
            if (!hyperModeActive) return;
            hyperModeActive = false;
            elements.slider.value = 100;
            updateBeerVisualization(100);
            updateAppTheme(userProfile.colorIndex, false, false);
            stopBeerRain();
        }
        function activateHepaMode(withAnimation) {
            if (hepaModeActive) return;
            hepaModeActive = true;
            updateBeerVisualization(-20);
            updateAppTheme(userProfile.colorIndex, false, true);
        }
        function deactivateHepaMode() {
            if (!hepaModeActive) return;
            hepaModeActive = false;
            elements.slider.value = 0;
            updateBeerVisualization(0);
            updateAppTheme(userProfile.colorIndex, false, false);
        }
        function startBeerRain() {
            const rainContainers = [elements.beerRainBack, elements.beerRainFront];
            rainContainers.forEach(container => {
                container.innerHTML = ''; // Clear previous rain
                const mainElement = elements.todayPage;
                for (let i = 0; i < 25; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'beer-drop';
                    drop.style.left = `${Math.random() * 100}%`;
                    const duration = (0.5 + Math.random() * 0.5) * 1000;
                    drop.style.animationDelay = `${Math.random() * 1000}ms`;
                    container.appendChild(drop);

                    const animation = drop.animate([
                        { transform: 'translateY(-20px)', opacity: 0 },
                        { opacity: 1, offset: 0.1 },
                        { transform: `translateY(${mainElement.clientHeight - elements.publishBtn.offsetHeight}px)`, opacity: 1 }
                    ], {
                        duration: duration,
                        delay: parseFloat(drop.style.animationDelay),
                    });

                    animation.onfinish = () => {
                        const splash = document.createElement('div');
                        splash.className = 'splash';
                        splash.style.left = drop.style.left;
                        splash.style.bottom = `${elements.publishBtn.offsetHeight}px`;
                        container.appendChild(splash);
                        setTimeout(() => {
                           if(container.contains(splash)) container.removeChild(splash);
                        }, 300);
                        if(container.contains(drop)) container.removeChild(drop);
                    };
                }
            });
        }
        function stopBeerRain() {
            elements.beerRainBack.innerHTML = '';
            elements.beerRainFront.innerHTML = '';
        }
        
        const formatDate = (d, fmt) => fmt.replace('YYYY', d.getFullYear()).replace('M', d.getMonth() + 1).replace('D', d.getDate()).replace('W', ['日','月','火','水','木','金','土'][d.getDay()]);
        const getHeartIcon = (l, s=1, c='') => { const cl={0:'text-gray-600',1:'text-amber-300',2:'text-amber-400',3:'text-orange-400',4:'text-orange-500',5:'text-red-500'}, f=l>=4?`drop-shadow(0 0 12px ${l===5?'#f59e0b88':'#fb923c88'})`:'', p=`<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>`; return `<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full ${cl[l]||cl[0]} ${c}" style="transform:scale(${s});filter:${f};" fill="${l===0?'none':'currentColor'}" stroke="${l===0?'currentColor':'none'}" stroke-width="1.5" viewBox="0 0 24 24">${p}</svg>`; };
        const getTrashIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
        const getLogicalToday = () => { const n = new Date(); if (n.getHours() < 5) n.setDate(n.getDate() - 1); return n; };
        
        const generateAvatar = (seed, colorIndex, c='w-24 h-24 text-4xl') => {
            if(!seed) seed = '?';
            const colors = AVATAR_COLORS[colorIndex] || AVATAR_COLORS[0];
            const initial = seed.charAt(0).toUpperCase();
            return `<div class="rounded-full ${c} flex items-center justify-center" style="background-image: linear-gradient(to bottom right, ${colors[0]}, ${colors[1]})"><span class="font-bold text-white">${initial}</span></div>`;
        };

        function formatTimeAgo(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const now = new Date();
            const seconds = Math.floor((now - timestamp.toDate()) / 1000);
            if (seconds < 60) return 'たった今';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}分前`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}時間前`;
            return `${Math.floor(hours / 24)}日前`;
        }

        // --- Schedule Page Functions ---
        function generateDateList() {
            const container = document.createElement('div');
            container.className = 'date-item-container';
            const today = getLogicalToday();
            for (let i = 0; i < 8; i++) { // Changed to 8 days
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = formatDate(date, 'YYYY-MM-DD');
                const displayString = formatDate(date, 'M月D日 (W)');
                const div = document.createElement('div');
                div.id = `date-${dateString}`;
                div.className = 'date-item';
                div.dataset.date = dateString;
                div.dataset.displayDate = displayString;
                let dayLabel = i === 0 ? '今日' : i === 1 ? '明日' : displayString;
                div.innerHTML = `
                    <div class="date-item-header p-4 flex items-center justify-between cursor-pointer interactive-item" data-action="toggle-details">
                        <div class="flex-grow">
                            <p class="font-bold text-base text-gray-100">${dayLabel} <span class="text-gray-400 font-normal text-sm">${i > 1 ? '' : displayString}</span></p>
                            <div class="text-sm text-gray-400 flex items-center gap-3 mt-1" id="stats-${dateString}"></div>
                        </div>
                        <button class="main-heart-icon w-16 h-16 flex-shrink-0 flex items-center justify-center rounded-full" data-action="open-selector"></button>
                    </div>
                    <div class="details-container" id="details-${dateString}"></div>
                `;
                container.appendChild(div);
            }
            elements.dateListContainer.innerHTML = '';
            elements.dateListContainer.appendChild(container);
        }

        function listenToAllMotivationData() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const today = getLogicalToday();
            for (let i = 0; i < 8; i++) { // Changed to 8 days
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = formatDate(date, 'YYYY-MM-DD');
                const docRef = doc(db, `artifacts/${appId}/public/data/drinking_motivation`, dateString);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { records: {} };
                    updateDateItemUI(dateString, data.records || {});
                });
                unsubscribeListeners.push(unsubscribe);
            }
        }

        async function fetchUserProfile(uid) {
            if (userProfileCache.has(uid)) return userProfileCache.get(uid);
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const profile = userDoc.data();
                userProfileCache.set(uid, profile);
                return profile;
            }
            return { name: `User ${uid.substring(0, 4)}`, color: '#808080' };
        }

        function updateDateItemUI(dateString, records) {
            const dateElem = document.getElementById(`date-${dateString}`);
            if (!dateElem) return;

            const participatingRecords = Object.fromEntries(
                Object.entries(records || {}).filter(([,r]) => r && (r.level > 0 || (r.comment && r.comment.trim() !== '')))
            );
            const participatingRecordsArray = Object.values(participatingRecords);

            const votedRecords = participatingRecordsArray.filter(r => r.level > 0);
            const participantCount = votedRecords.length;
            const totalLevel = votedRecords.reduce((sum, record) => sum + (record.level || 0), 0);

            document.getElementById(`stats-${dateString}`).innerHTML = `
                <span class="flex items-center gap-1.5"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>${participantCount}</span>
                <span class="flex items-center gap-1.5">${getHeartIcon(3, 1, 'h-4 w-4')}${totalLevel}</span>`;
            
            const myRecord = records[userId] || { level: 0 };
            dateElem.classList.toggle('voted-on', myRecord.level > 0);
            const iconButton = dateElem.querySelector('.main-heart-icon');
            if (iconButton) {
                iconButton.innerHTML = getHeartIcon(myRecord.level, Math.min(0.8 + (totalLevel / 20), 2.0));
            }
            dateElem.dataset.records = JSON.stringify(participatingRecords);
            
            if (dateElem.classList.contains('is-open')) {
                renderParticipantList(dateString, participatingRecords);
            }
        }

        function toggleParticipantList(clickedItem) {
            const currentlyOpen = document.querySelector('.date-item.is-open');
            if (currentlyOpen && currentlyOpen !== clickedItem) {
                currentlyOpen.classList.remove('is-open');
            }
            clickedItem.classList.toggle('is-open');
            if (clickedItem.classList.contains('is-open')) {
                const records = JSON.parse(clickedItem.dataset.records || '{}');
                renderParticipantList(clickedItem.dataset.date, records);
            }
        }

        async function renderParticipantList(dateString, records) {
            const listContainer = document.getElementById(`details-${dateString}`);
            listContainer.innerHTML = '';

            const recordsArray = Object.entries(records);
            if (recordsArray.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">まだ誰もいません👀</p>';
                return;
            }

            recordsArray.sort(([, a], [, b]) => (b.level || 0) - (a.level || 0));
            const profiles = await Promise.all(recordsArray.map(([uid]) => fetchUserProfile(uid)));
            
            const listWrapper = document.createElement('div');
            listWrapper.className = 'space-y-1';
            recordsArray.forEach(([uid, record], index) => {
                const profile = profiles[index];
                const isMe = uid === userId;
                const commentHTML = record.comment ? `<p class="text-xs text-gray-400 truncate mt-0.5">${record.comment}</p>` : '';

                listWrapper.innerHTML += `
                    <div class="participant-item bg-[#2C2C2E] rounded-lg py-2 px-3 flex items-center justify-between cursor-pointer ${isMe ? 'ring-2 ring-amber-500' : ''}" data-user-id="${uid}" data-date="${dateString}">
                        <div class="flex-grow min-w-0 pr-2">
                            <p class="font-medium text-sm text-gray-200 truncate">${profile.name}</p>
                            ${commentHTML}
                        </div>
                        <div class="flex items-center justify-end gap-1.5 flex-shrink-0">
                            <div class="w-4 h-4">${getHeartIcon(record.level || 0)}</div>
                            <span class="font-bold text-sm w-4 text-right text-gray-200">${record.level || 0}</span>
                        </div>
                    </div>`;
            });
            listContainer.appendChild(listWrapper);
        }

        async function openScheduleCommentModal(dateString) {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/public/data/drinking_motivation`, dateString);
            const docSnap = await getDoc(docRef);
            let currentComment = '';
            
            if (docSnap.exists()) {
                const records = docSnap.data().records;
                if (records && records[userId] && records[userId].comment) {
                    currentComment = records[userId].comment;
                }
            }

            elements.commentModal.input.value = currentComment;
            elements.commentModal.saveBtn.dataset.context = dateString;
            elements.commentModal.container.classList.add('is-open');
        }

        function openLevelSelector(date) {
            const container = elements.levelSelectorModal.options;
            if (!container) return;
            container.innerHTML = '';
            [1, 2, 3, 4, 5, 0].forEach(i => {
                const div = document.createElement('div');
                div.className = 'text-center cursor-pointer transition-transform duration-200 hover:scale-110 active:scale-95';
                div.innerHTML = i === 0
                    ? `<div class="text-5xl h-16 w-12 flex items-center justify-center text-gray-500">${getTrashIcon()}</div>`
                    : `<div class="text-5xl h-16 w-12 flex items-center justify-center">${getHeartIcon(i)}</div>`;
                div.addEventListener('click', () => saveMotivation(date, i));
                container.appendChild(div);
            });
            elements.levelSelectorModal.container.classList.add('is-open');
        }

        async function saveMotivation(dateString, level) {
            if (!userId) return;
            elements.levelSelectorModal.container.classList.remove('is-open');
            const docRef = doc(db, `artifacts/${appId}/public/data/drinking_motivation`, dateString);

            try {
                if (level === 0) {
                    const userRecordPath = `records.${userId}`;
                    await updateDoc(docRef, { [userRecordPath]: deleteField() });
                } else {
                    const levelFieldPath = `records.${userId}.level`;
                    await updateDoc(docRef, { [levelFieldPath]: level });
                }
            } catch (error) {
                if (error.code === 'not-found') {
                    if (level > 0) {
                        await setDoc(docRef, { records: { [userId]: { level } } });
                    }
                } else {
                    console.error("Save Error:", error);
                }
            }
        }

        main();
    </script>
</body>
</html>
